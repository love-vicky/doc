<!DOCTYPE html>
<!-- saved from url=(0038)https://www.jianshu.com/p/26acd6185747 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script src="./ceph存储引擎bluestore解析 - 简书_files/osd.js.下载"></script><script src="./ceph存储引擎bluestore解析 - 简书_files/f(4).txt"></script><script src="./ceph存储引擎bluestore解析 - 简书_files/f(5).txt" id="google_shimpl"></script><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="Cache-Control" content="no-transform"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="theme-color" content="#ec7259"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta name="google" value="notranslate"><meta property="wb:webmaster" content="294ec9de89e7fadb"><meta property="qc:admins" content="104102651453316562112116375"><meta property="qc:admins" content="11635613706305617"><meta property="qc:admins" content="1163561616621163056375"><meta name="360-site-verification" content="604a14b53c6b871206001285921e81d8"><meta name="google-site-verification" content="cV4-qkUJZR6gmFeajx_UyPe47GW9vY6cnCrYtCHYNh4"><meta name="google-site-verification" content="HF7lfF8YEGs1qtCE-kPml8Z469e2RHhGajy6JPVy5XI"><meta name="tencent-site-verification" content="da26ce22cfed7aba6a96d8409f9b53a6"><meta name="apple-mobile-web-app-title" content="简书"><link rel="dns-prefetch" href="https://cdn2.jianshu.io/"><link rel="dns-prefetch" href="https://upload-images.jianshu.io/"><meta http-equiv="mobile-agent" content="format=html5; url=https://www.jianshu.com/p/26acd6185747"><meta name="apple-itunes-app" content="app-id=888237539, app-argument=jianshu://notes/17187165"><meta property="al:ios:url" content="jianshu://notes/17187165"><meta property="al:ios:app_store_id" content="888237539"><meta property="al:ios:app_name" content="简书"><meta property="al:android:url" content="jianshu://notes/17187165"><meta property="al:android:package" content="com.jianshu.haruki"><meta property="al:android:app_name" content="简书"><title>ceph存储引擎bluestore解析 - 简书</title><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="description" content="ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memstore以及最新的bluestore，目前默认使用的files..."><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@jianshu.com"><meta property="fb:app_id" content="865829053512461"><meta property="og:url" content="https://www.jianshu.com/p/26acd6185747"><meta property="og:type" content="article"><meta property="og:title" content="ceph存储引擎bluestore解析"><meta property="og:description" content="ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memstore以及最新的bluestore，目前默认使用的files..."><meta property="og:image" content="http://upload-images.jianshu.io/upload_images/7240015-76c6c8ee954202ca"><meta property="og:site_name" content="简书"><meta name="next-head-count" content="45"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/[slug].js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/_app.js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/webpack-ad03007e443a25fa4d15.js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/commons.6f517ba4cf1108d0202d.js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/styles.4eb5917714db060a5a06.js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/main-c0e08023b1a3520cf518.js.下载" as="script"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/commons.d54d167b.chunk.css" as="style"><link rel="stylesheet" href="./ceph存储引擎bluestore解析 - 简书_files/commons.d54d167b.chunk.css"><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/styles.521034ee.chunk.css" as="style"><link rel="stylesheet" href="./ceph存储引擎bluestore解析 - 简书_files/styles.521034ee.chunk.css"><link rel="stylesheet" type="text/css" href="./ceph存储引擎bluestore解析 - 简书_files/12.9f0bd644.chunk.css"><script charset="utf-8" src="./ceph存储引擎bluestore解析 - 简书_files/12.eb49efa92f6ab9adcbd5.js.下载"></script><link rel="stylesheet" type="text/css" href="./ceph存储引擎bluestore解析 - 简书_files/13.9226e3ca.chunk.css"><script charset="utf-8" src="./ceph存储引擎bluestore解析 - 简书_files/13.dc4335a28f6664933e12.js.下载"></script><script charset="utf-8" src="./ceph存储引擎bluestore解析 - 简书_files/11.75b56346ed2db2849ee4.js.下载"></script><script charset="utf-8" src="./ceph存储引擎bluestore解析 - 简书_files/15.68f3d52cebcd122a7753.js.下载"></script><link rel="preload" href="./ceph存储引擎bluestore解析 - 简书_files/f(6).txt" as="script"><script type="text/javascript" src="./ceph存储引擎bluestore解析 - 简书_files/f(6).txt"></script></head><body class=""><svg class="wCYvWN" style="display:none;width:0;height:0" width="0" height="0" focusable="false" aria-hidden="true"><a href="https://www.jianshu.com/sign_in" target="_blank" class="_2MpoKb _1OyPqC _1AT95S _2WY0RL" role="button" tabindex="-1"><span>登录</span></a><a href="https://www.jianshu.com/sign_up" target="_blank" class="_2MpoKb _1OyPqC _3Mi9q9 _2WY0RL" role="button" tabindex="-1"><span>注册</span></a><a href="https://www.jianshu.com/writer" target="_blank" class="_1OyPqC _3Mi9q9 _2WY0RL _1YbC5u" role="button" tabindex="-1"><i aria-label="ic-write" style="margin-right:2px" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-write"></use></svg></i><span>写文章</span></a></div><div class="_1YyUun"><div class="_2RZATq"><nav class="_3JYrtj"><a class="hM7XFL _1OhGeD" href="https://www.jianshu.com/">首页</a><a class="hM7XFL _1OhGeD" href="https://www.jianshu.com/apps?utm_medium=desktop&amp;utm_source=navbar-apps">下载APP</a></nav><div class="MoRCpo"><div class="_31TNvD"><input type="search" class="_2q13cl G1b3UE" value="" placeholder="搜索" aria-label="搜索专题"><span class="x6-7Eb" role="button" tabindex="-1" aria-label="搜索"><i aria-label="icon: search" class="anticon anticon-search"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i></span></div></div></div></div></div><div class="_3t3lfz"><div class="FTZkZo"><div class="_16zCst"><h1 class="_2zeTMs" title="ceph存储引擎bluestore解析">ceph存储引擎bluestore解析</h1></div><div class="_26qd_C"><a class="qzhJKO" href="https://www.jianshu.com/u/f796a54054d1"><img class="_2JlnTn" src="./ceph存储引擎bluestore解析 - 简书_files/26c0bdb2-2375-41b5-9292-5b5256f57114.jpg" alt=""><span class="_22gUMi">LeiLv</span></a><button data-locale="zh-CN" type="button" class="_1OyPqC _3Mi9q9"><span>关注</span></button><button type="button" class="_1OyPqC _3Mi9q9 _1YbC5u"><span>赞赏支持</span></button></div></div></div></div><div class="VYwngI"></div></header><div class="_21bLU4 _3kbg6I"><div class="_3VRLsv" role="main"><div class="_gp-ck"><section class="ouvJEz"><h1 class="_1RuRku">ceph存储引擎bluestore解析</h1><div class="rEsl9f"><div class="_2mYfmT"><a class="_1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer"><img class="_13D2Eh" src="./ceph存储引擎bluestore解析 - 简书_files/26c0bdb2-2375-41b5-9292-5b5256f57114(1).jpg" alt=""></a><div style="margin-left: 8px;"><div class="_3U4Smb"><span class="FxYr8x"><a class="_1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer">LeiLv</a></span><button data-locale="zh-CN" type="button" class="_3kba3h _1OyPqC _3Mi9q9 _34692-"><span>关注</span></button></div><div class="s-dsoj"><time datetime="2017-09-17T05:59:12.000Z">2017.09.17 13:59:12</time><span>字数 2,182</span><span>阅读 368</span></div></div></div></div><article class="_2rhmJa"><p>ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memstore以及最新的bluestore，目前默认使用的filestore，但是因为filestore在写数据前需要先写journal，会有一倍的写放大，并且filestore一开始只是对于机械盘进行设计的，没有专门针对ssd做优化考虑，因此诞生的bluestore初衷就是为了减少写放大，并针对ssd做优化，而且直接管理裸盘，从理论上进一步减少文件系统如ext4/xfs等部分的开销，目前bluestore还处于开发优化阶段，在jewel版本还是试用版本，并且最新的master相比jewel已经做了大的重构，预期会在后续的大版本中稳定下来成为默认的存储引擎。本文基于master分支对bluestore存储引擎进行分析。<br></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>bluestore整体架构</b></a></p><div class="image-package">
<div class="image-container" style="max-width: 414px; max-height: 280px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 67.63%;"></div>
<div class="image-view" data-width="414" data-height="280"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-347c3bcbb7e7f270" data-original-width="414" data-original-height="280" data-original-format="image/png" data-original-filesize="16098" data-image-index="0" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-347c3bcbb7e7f270"></div>
</div>
<div class="image-caption"></div>
</div><p>bluestore直接管理裸设备，抛弃了ext4/xfs等本地文件系统，BlockDevice实现在用户态下使用linux aio直接对裸设备进行I/O操作。既然是直接管理裸设备就必然需要进行裸设备的空间管理，对应的就是Allocator，目前支持StupidAllocator和BitmapAllocator两种分配器。相关的元数据以kv的形式保存到kv数据库里，默认使用的是rocksdb，由于rocksdb本身是基于文件系统的，不是直接操作裸设备，但是rocksdb也比较灵活，将系统相关的处理抽象成Env，用户可用实现相应的接口，rocksdb默认的Env是PosixEnv，直接对接本地文件系统，为此，bluestore实现了一个BlueRocksEnv，继承自EnvWrapper，来为rocksdb提供底层系统的封装，为了对接BlueRocksEnv，实现了一个小的文件系统BlueFS，只实现rocksdb Env需要的接口，在系统启动mount这个文件系统的时候将所有的元数据都加载到内存中，BluesFS的数据和日志文件都通过BlockDevice保存到裸设备上，BlueFS和BlueStore可以共享裸设备，也可以分别指定不同的设备。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>bluestore元数据</b></a></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 298px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 46.56%;"></div>
<div class="image-view" data-width="640" data-height="298"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-1a56e633fde7fceb" data-original-width="640" data-original-height="298" data-original-format="image/png" data-original-filesize="37840" data-image-index="1" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-1a56e633fde7fceb"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p>在之前的存储引擎filestore里，对象的表现形式是对应到文件系统里的文件，默认4MB大小的文件，但是在bluestore里，已经没有传统的文件系统，而是自己管理裸盘，因此需要有元数据来管理对象，对应的就是Onode，Onode是常驻内存的数据结构，持久化的时候会以kv的形式存到rocksdb里。</p><p>在onode里又分为lextent，表示逻辑的数据块，用一个map来记录，一个onode里会存在多个lextent，lextent通过blob的id对应到blob（bluestore_blob_t ），blob里通过pextent对应到实际物理盘上的区域（pextent里就是offset和length来定位物理盘的位置区域）。一个onode里的多个lextent可能在同一个blob里，而一个blob也可能对应到多个pextent。</p><p>另外还有Bnode这个元数据，它是用来表示多个object可能共享extent，目前在做了快照后写I/O触发的cow进行clone的时候会用到。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>I/O读写映射逻辑</b></a></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>写I/O处理</b></a></p><p>到达bluestore的I/O的offset和length都是对象内（onode）的，offset是相对于这个对象起始位置的偏移，在_do_write里首先就会根据最小分配单位min_alloc_size进行判断，从而将I/O分为对齐和非对齐的。如下图所示：</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 605px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 94.53%;"></div>
<div class="image-view" data-width="640" data-height="605"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-76c6c8ee954202ca" data-original-width="640" data-original-height="605" data-original-format="image/jpeg" data-original-filesize="37512" data-image-index="2" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-76c6c8ee954202ca"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p>当一个写请求按照min_alloc_size进行拆分后，就会分为对齐写，对应到do_write_big，非对齐写（即落到某一个min_alloc_size区间的写I/O（对应到do_write_small）。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>do_write_big</b></a></p><p>对齐到min_alloc_size的写请求处理起来比较简单，有可能是多个min_alloc_size的大小，在处理时会根据实际大小新生成lextent和blob，这个lextent跨越的区域是min_alloc_size的整数倍，如果这段区间是之前写过的，会将之前的lextent记录下来便于后续的空间回收。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>do_write_small</b></a></p><p>在处理落到某个min_alloc_size区间的写请求时，会首先根据offset去查找有没有可以复用的blob，因为最小分配单元是min_alloc_size，默认64KB，如果一个4KB的写I/O就只会用到blob的一部分，blob里剩余的还能放其他的。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>1）没有找到可以复用的blob，新生成blob</b></a></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 616px; max-height: 389px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 63.14999999999999%;"></div>
<div class="image-view" data-width="616" data-height="389"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-7fd66a37c6a59c52" data-original-width="616" data-original-height="389" data-original-format="image/png" data-original-filesize="17245" data-image-index="3" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-7fd66a37c6a59c52"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p>在处理还还需要根据offset和len是否对齐到block_size（默认是4KB）进行补零对齐的操作，之所以需要补齐是与后续的写盘操作有关，真正写盘时有两种方式，一种是Direct I/O的方式，这种要求偏移和缓冲区都对齐的，另外一种非Direct I/O，即Buffered I/O，这种可以不对齐，但是是写到cache里，然后再sync刷到磁盘上，比如只写了100字节，在内核里是需要先从设备上读出来补齐成一个完整的扇区，然后再刷的，这样反而降低了效率。因此在bluestore里直接处理好对齐，对于后面的写盘来说比较有利，这里对齐到block_size，是个可配置的参数。</p><p>进行对齐补零时就是按照如上图那样把前后对齐到block_size，然后再把对齐后的offset和len作为lextent，进而放到blob里。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>2）找到可以复用的blob</b></a></p><p>对于可以复用的blob，也是先按照block_size进行对齐补零的动作，然后再判断是否可以直接使用blob里空闲的空间进行区分做不同的处理。</p><p><b>a）直接写在blob未使用的空间上</b></p><p>这种情况下直接新生成lextent放到blob里。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 538px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 84.06%;"></div>
<div class="image-view" data-width="640" data-height="538"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-961b13b2350ee89a" data-original-width="640" data-original-height="538" data-original-format="image/jpeg" data-original-filesize="28251" data-image-index="4" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-961b13b2350ee89a"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p><b>b）覆盖写的情况</b></p><p>比如下面的这种情况，写I/O会覆盖部分已经写过的数据。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 240px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 37.5%;"></div>
<div class="image-view" data-width="640" data-height="240"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-5b70fa10d6f7f9a0" data-original-width="640" data-original-height="240" data-original-format="image/png" data-original-filesize="35889" data-image-index="5" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-5b70fa10d6f7f9a0"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p>对于这种情况的处理如下图：也是需要先处理对齐补零的情况，如果覆盖的区域刚好是已经对齐到block_size，那么就不需要从磁盘读数据，但是如果覆盖的区域没有对齐到block_size，那么就需要把不对齐的那部分读出来，拼成一个对齐的buffer，然后新生成lextent，并且会对原来那个lextent进行调整，会记录需要回收的那部分区域。对于覆盖写的情况，都不是直接写盘，而是通过wal写到rocksdb。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 367px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 57.34%;"></div>
<div class="image-view" data-width="640" data-height="367"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-05aaa1bdb7aa4179" data-original-width="640" data-original-height="367" data-original-format="image/png" data-original-filesize="62575" data-image-index="6" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-05aaa1bdb7aa4179"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>整体写I/O的逻辑</b></a></p><p>之前组内同事画过一个流程图，这里借用一下算是一个简单的总结。</p><div class="image-package">
<div class="image-container" style="max-width: 601px; max-height: 893px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 127.62%;"></div>
<div class="image-view" data-width="601" data-height="767"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-7b4030f7ddcc23c0" data-original-width="601" data-original-height="767" data-original-format="image/jpeg" data-original-filesize="77755" data-image-index="7" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-7b4030f7ddcc23c0"></div>
</div>
<div class="image-caption"></div>
</div><p><b>读I/O的处理</b></p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 188px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 29.38%;"></div>
<div class="image-view" data-width="640" data-height="188"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-f963f47ed8663a34" data-original-width="640" data-original-height="188" data-original-format="image/png" data-original-filesize="31058" data-image-index="8" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-f963f47ed8663a34"></div>
</div>
<div class="image-caption"></div>
</div><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><p>读I/O请求的处理时也是通过寻找相关联的lextent，可能会存在空洞的情况，即读到未写过的数据，这部分就直接补零。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"><b>clone及extent共享</b></a></p><p>前面说到Bnode就是用来记录共享的lextent，目前是在做完快照后对原卷进行写I/O会触发cow，从而产生clone操作。clone时就是将原对象的blob从onode-&gt;blob_map移到onode-&gt;bnode-&gt;blob_map，并且将blob id置为负的，并设置共享标记，然后将新的快照对象的onode-&gt;bnode指向原对象的onode-&gt;bnode，并且用原onode里的lextents里的值赋给新的onode的lextents，从而达到共享extent的目的，图示仅供参考。</p><p><a href="https://www.jianshu.com/p/26acd6185747" target="_blank"></a></p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 343px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 53.59%;"></div>
<div class="image-view" data-width="640" data-height="343"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-a9e96272bca28bac" data-original-width="640" data-original-height="343" data-original-format="image/png" data-original-filesize="38864" data-image-index="9" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-a9e96272bca28bac"></div>
</div>
<div class="image-caption"></div>
</div><p>在clone完之后，继续对原对象进行写I/O操作时，当碰到共享的blob时就需要跳过，新生成blob，并且取消对原来那部分lextent的引用，在后续的空间释放时的判断依据就是否还有引用。</p><div class="image-package">
<div class="image-container" style="max-width: 640px; max-height: 378px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 59.06%;"></div>
<div class="image-view" data-width="640" data-height="378"><img data-original-src="//upload-images.jianshu.io/upload_images/7240015-d15c0ee764fff2dd" data-original-width="640" data-original-height="378" data-original-format="image/jpeg" data-original-filesize="22294" data-image-index="10" style="cursor: zoom-in;" class="" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-d15c0ee764fff2dd"></div>
</div>
<div class="image-caption"></div>
</div><p><b>小结</b></p><p>本文总体上介绍了bluestore的架构、相关元数据及内部I/O映射的逻辑，这还只是bluestore的冰山一角，后续会陆续对bluestore的处理流程、空间分配器、缓存管理、压缩等实现进行分析。</p><p>来源：<a href="https://www.jianshu.com/p/26acd6185747" target="_blank">System Notes</a></p><p>原文：http://www.sysnote.org/2016/08/19/ceph-bluestore/</p></article><div></div><div class="_1kCBjS"><div class="_18vaTa"><div class="_3BUZPB"><div class="_2Bo4Th" role="button" tabindex="-1" aria-label="给文章点赞"><i aria-label="ic-like" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-like"></use></svg></i></div><span class="_1LOh_5" role="button" tabindex="-1" aria-label="查看点赞列表">0人点赞<i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></span></div><div class="_3BUZPB"><div class="_2Bo4Th" role="button" tabindex="-1"><i aria-label="ic-dislike" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-dislike"></use></svg></i></div></div></div><div class="_18vaTa"><a class="_3BUZPB _1x1ok9 _1OhGeD" href="https://www.jianshu.com/nb/16614996" target="_blank" rel="noopener noreferrer"><i aria-label="ic-notebook" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-notebook"></use></svg></i><span>架构师</span></a><div class="_3BUZPB ant-dropdown-trigger"><div class="_2Bo4Th"><i aria-label="ic-others" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-others"></use></svg></i></div></div></div></div><div class="_19DgIp" style="margin-top:24px;margin-bottom:24px"></div><div class="_13lIbp"><div class="_191KSt">"小礼物走一走，来简书关注我"</div><button type="button" class="_1OyPqC _3Mi9q9 _2WY0RL _1YbC5u"><span>赞赏支持</span></button><span class="_3zdmIj">还没有人赞赏，支持一下</span></div><div class="d0hShY"><a class="_1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer"><img class="_27NmgV" src="./ceph存储引擎bluestore解析 - 简书_files/26c0bdb2-2375-41b5-9292-5b5256f57114(2).jpg" alt="  "></a><div class="Uz-vZq"><div class="Cqpr1X"><a class="HC3FFO _1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" title="LeiLv" target="_blank" rel="noopener noreferrer">LeiLv</a><span class="_2WEj6j" title=""></span></div><div class="lJvI3S"><span>总资产112 (约10.60元)</span><span>共写了93.5W字</span><span>获得1,631个赞</span><span>共1,295个粉丝</span></div></div><button data-locale="zh-CN" type="button" class="_1OyPqC _3Mi9q9"><span>关注</span></button></div></section><section class="sFiE8U" aria-label="google-ad"><ins class="adsbygoogle" style="display:inline-block;width:730px;height:114px" data-ad-client="ca-pub-3077285224019295" data-ad-slot="2979144022" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:114px;margin:0;padding:0;position:relative;visibility:visible;width:730px;background-color:transparent;"><ins id="aswift_0_anchor" style="display:block;border:none;height:114px;margin:0;padding:0;position:relative;visibility:visible;width:730px;background-color:transparent;"><iframe id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;border:0;width:730px;height:114px;" sandbox="allow-forms allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation" width="730" height="114" frameborder="0" src="./ceph存储引擎bluestore解析 - 简书_files/ads.html" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" data-google-container-id="a!1" data-google-query-id="CK_bvfnKi-oCFYdkvAodJsIOYg" data-load-complete="true"></iframe></ins></ins></ins><script type="text/javascript" src="./ceph存储引擎bluestore解析 - 简书_files/f(7).txt" async=""></script></section><div id="note-page-comment"><section class="ouvJEz"><div class="_26JdYM"><img class="_3LHFA-" src="https://www.jianshu.com/p/26acd6185747" alt=""><div class="_3GKFE3"><textarea class="_1u_H4i" placeholder="写下你的评论..."></textarea><div></div></div></div><div class="_2lR7N6" style="display: none;"><div class="_17_lFi"><div class="_3k5vgx"></div><div><div class="U36Th9"></div><div class="_9aTHBB"></div></div></div><div class="_1Lq8tt"></div><div class="_1Lq8tt _1muh0x"></div><div class="_3Pu4Wf"><i aria-label="ic-like" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-like"></use></svg></i><div class="_1mcOnW"></div><i aria-label="ic-reply" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-reply"></use></svg></i><div class="_1mcOnW"></div></div></div><h3 class="QxT4hD"><div class="_10KzV0"><span>全部评论</span><span class="_2R7vBo">0</span><span class="_1DVmvZ" role="checkbox" tabindex="0" aria-label="只看作者" aria-checked="false">只看作者</span></div><div class="_2zSaYx"><div class="_1ekjko _1BIpxf" role="button" tabindex="-1">按时间倒序</div><div class="_1ekjko" role="button" tabindex="-1">按时间正序</div></div></h3><div class="_2lR7N6" style="display: none;"><div class="_17_lFi"><div class="_3k5vgx"></div><div><div class="U36Th9"></div><div class="_9aTHBB"></div></div></div><div class="_1Lq8tt"></div><div class="_1Lq8tt _1muh0x"></div><div class="_3Pu4Wf"><i aria-label="ic-like" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-like"></use></svg></i><div class="_1mcOnW"></div><i aria-label="ic-reply" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-reply"></use></svg></i><div class="_1mcOnW"></div></div></div></section></div><section class="ouvJEz"><h3 class="QxT4hD"><span>推荐阅读</span><a class="_29KFEa _1OhGeD" href="https://www.jianshu.com/" target="_blank" rel="noopener noreferrer">更多精彩内容<i aria-label="ic-right" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-right"></use></svg></i></a></h3><ul class="_1iTR78"><li class="_11jppn"><div class="JB6qEE"><div class="em6wEs" title="ceph存储引擎bluestore解析" role="heading" aria-level="4"><a class="_2voXH8 _1OhGeD" href="https://www.jianshu.com/p/c46a4178bb93" target="_blank" rel="noopener noreferrer">ceph存储引擎bluestore解析</a></div><div class="_3fvgn4">ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memst...</div><div class="_1pJt6F"><a class="_3IWz1q _1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer"><img class="_34VC_H" src="./ceph存储引擎bluestore解析 - 简书_files/26c0bdb2-2375-41b5-9292-5b5256f57114(3).jpg" alt=""><span class="_3tPsL6">LeiLv</span></a><span class="_31hjBO">阅读<!-- --> <!-- -->3,895</span><span class="_31hjBO">评论<!-- --> <!-- -->0</span><span class="_31hjBO">赞<!-- --> <!-- -->2</span></div></div><a class="_10MMAm _1OhGeD" href="https://www.jianshu.com/p/c46a4178bb93" target="_blank" rel="noopener noreferrer"><img class="_3zGDUj" src="./ceph存储引擎bluestore解析 - 简书_files/7240015-f414db564eff652f" alt=""></a></li><li class="_11jppn"><div class="JB6qEE"><div class="em6wEs" title="iOS ffmpeg 理解" role="heading" aria-level="4"><a class="_2voXH8 _1OhGeD" href="https://www.jianshu.com/p/534a5bdc9aaa" target="_blank" rel="noopener noreferrer">iOS ffmpeg 理解</a></div><div class="_3fvgn4">教程一:视频截图(Tutorial 01: Making Screencaps) 首先我们需要了解视频文件的一些基...</div><div class="_1pJt6F"><a class="_3IWz1q _1OhGeD" href="https://www.jianshu.com/u/c89332076e7a" target="_blank" rel="noopener noreferrer"><img class="_34VC_H" src="./ceph存储引擎bluestore解析 - 简书_files/7ab503d7-5e82-4f35-b273-8d9620fe4523.jpg" alt=""><span class="_3tPsL6">90后的思维</span></a><span class="_31hjBO">阅读<!-- --> <!-- -->2,472</span><span class="_31hjBO">评论<!-- --> <!-- -->0</span><span class="_31hjBO">赞<!-- --> <!-- -->3</span></div></div></li><li class="_11jppn"><div class="JB6qEE"><div class="em6wEs" title="LeetCode/LintCode ReviewPage 题解-总结" role="heading" aria-level="4"><a class="_2voXH8 _1OhGeD" href="https://www.jianshu.com/p/9bc86a6bbbbc" target="_blank" rel="noopener noreferrer">LeetCode/LintCode ReviewPage 题解-总结</a></div><div class="_3fvgn4">背景 一年多以前我在知乎上答了有关LeetCode的问题, 分享了一些自己做题目的经验。 张土汪：刷leetcod...</div><div class="_1pJt6F"><a class="_3IWz1q _1OhGeD" href="https://www.jianshu.com/u/0e6b059ad57e" target="_blank" rel="noopener noreferrer"><img class="_34VC_H" src="./ceph存储引擎bluestore解析 - 简书_files/a1cc2282234d.jpg" alt=""><span class="_3tPsL6">张土汪</span></a><span class="_31hjBO">阅读<!-- --> <!-- -->9,895</span><span class="_31hjBO">评论<!-- --> <!-- -->0</span><span class="_31hjBO">赞<!-- --> <!-- -->31</span></div></div><a class="_10MMAm _1OhGeD" href="https://www.jianshu.com/p/9bc86a6bbbbc" target="_blank" rel="noopener noreferrer"><img class="_3zGDUj" src="./ceph存储引擎bluestore解析 - 简书_files/1088843-4dbeb1d476ae23b2.jpg" alt=""></a></li><li class="_11jppn"><div class="JB6qEE"><div class="em6wEs" title="《MySQL技术内幕：InnoDB存储引擎(第2版)﻿》书摘" role="heading" aria-level="4"><a class="_2voXH8 _1OhGeD" href="https://www.jianshu.com/p/3eca0b18cf51" target="_blank" rel="noopener noreferrer">《MySQL技术内幕：InnoDB存储引擎(第2版)﻿》书摘</a></div><div class="_3fvgn4">MySQL技术内幕：InnoDB存储引擎(第2版) 姜承尧 第1章 MySQL体系结构和存储引擎 &gt;&gt; 在上述例子...</div><div class="_1pJt6F"><a class="_3IWz1q _1OhGeD" href="https://www.jianshu.com/u/6ca93a173ea2" target="_blank" rel="noopener noreferrer"><img class="_34VC_H" src="./ceph存储引擎bluestore解析 - 简书_files/1-04bbeead395d74921af6a4e8214b4f61.jpg" alt=""><span class="_3tPsL6">沉默剑士</span></a><span class="_31hjBO">阅读<!-- --> <!-- -->4,430</span><span class="_31hjBO">评论<!-- --> <!-- -->0</span><span class="_31hjBO">赞<!-- --> <!-- -->15</span></div></div></li><li class="_11jppn"><div class="JB6qEE"><div class="em6wEs" title="1.24-生活不在别处" role="heading" aria-level="4"><a class="_2voXH8 _1OhGeD" href="https://www.jianshu.com/p/565a8ba2e347" target="_blank" rel="noopener noreferrer">1.24-生活不在别处</a></div><div class="_3fvgn4">“心灵对话•写作”小组第11篇文字 在朋友家做客一周，心理小组也持续了几乎一周。每天都要聊聊内心的话题，感觉内心平...</div><div class="_1pJt6F"><a class="_3IWz1q _1OhGeD" href="https://www.jianshu.com/u/4dc939d7d71b" target="_blank" rel="noopener noreferrer"><img class="_34VC_H" src="./ceph存储引擎bluestore解析 - 简书_files/e9ad8adb-21f6-48c5-a89b-18102c97d414.jpg" alt=""><span class="_3tPsL6">尼农的小鹿</span></a><span class="_31hjBO">阅读<!-- --> <!-- -->123</span><span class="_31hjBO">评论<!-- --> <!-- -->4</span><span class="_31hjBO">赞<!-- --> <!-- -->2</span></div></div><a class="_10MMAm _1OhGeD" href="https://www.jianshu.com/p/565a8ba2e347" target="_blank" rel="noopener noreferrer"><img class="_3zGDUj" src="./ceph存储引擎bluestore解析 - 简书_files/4218602-9922a42e2df5cc93.jpg" alt=""></a></li></ul></section></div><aside class="_2OwGUo"><section class="-umr26" aria-label="jianshu-ad"><img class="QrLrqK" src="./ceph存储引擎bluestore解析 - 简书_files/note_page_right_sidebar_ad2-cdb24be0bc9321958a33b818173248e4.jpg" alt=""><span class="_22kSId">广告</span></section><section class="_3Z3nHf"><div class="_3Oo-T1"><a class="_1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer"><img class="_3T9iJQ" src="./ceph存储引擎bluestore解析 - 简书_files/26c0bdb2-2375-41b5-9292-5b5256f57114(4).jpg" alt=""></a><div class="_32ZTTG"><div class="_2O0T_w"><div class="_2v-h3G"><span class="_2vh4fr" title="LeiLv"><a class="_1OhGeD" href="https://www.jianshu.com/u/f796a54054d1" target="_blank" rel="noopener noreferrer">LeiLv</a></span></div><button data-locale="zh-CN" type="button" class="tzrf9N _1OyPqC _3Mi9q9 _34692-"><span>关注</span></button></div><div class="_1pXc22">总资产112 (约10.60元)</div></div></div><div class="_19DgIp"></div><div class="_26Hhi2" role="listitem"><div class="_3TNGId" title="Python中文转Unicode"><a class="_2ER8Tt _1OhGeD" href="https://www.jianshu.com/p/0b34fffcc489" target="_blank" rel="noopener noreferrer">Python中文转Unicode</a></div><div class="DfvGP9">阅读 159</div></div><div class="_26Hhi2" role="listitem"><div class="_3TNGId" title="C++ 获取任务栏图标信息"><a class="_2ER8Tt _1OhGeD" href="https://www.jianshu.com/p/6b52c3982cc5" target="_blank" rel="noopener noreferrer">C++ 获取任务栏图标信息</a></div><div class="DfvGP9">阅读 288</div></div></section><div><div class="" style=""><section class="_3Z3nHf"><h3 class="QHRnq8 QxT4hD"><span>推荐阅读</span></h3><div class="cuOxAY" role="listitem"><div class="_3L5YSq" title="凤九东华续【第二章】"><a class="_1-HJSV _1OhGeD" href="https://www.jianshu.com/p/eb1581e03197" target="_blank" rel="noopener noreferrer">凤九东华续【第二章】</a></div><div class="_19haGh">阅读 5,614</div></div><div class="cuOxAY" role="listitem"><div class="_3L5YSq" title="东凤虐恋 15 醋坛子"><a class="_1-HJSV _1OhGeD" href="https://www.jianshu.com/p/79fc3013c30e" target="_blank" rel="noopener noreferrer">东凤虐恋 15 醋坛子</a></div><div class="_19haGh">阅读 5,803</div></div><div class="cuOxAY" role="listitem"><div class="_3L5YSq" title="枕上书续 第一章 苏醒（5）"><a class="_1-HJSV _1OhGeD" href="https://www.jianshu.com/p/a10ec9fdab25" target="_blank" rel="noopener noreferrer">枕上书续 第一章 苏醒（5）</a></div><div class="_19haGh">阅读 3,479</div></div><div class="cuOxAY" role="listitem"><div class="_3L5YSq" title="二十五岁的我"><a class="_1-HJSV _1OhGeD" href="https://www.jianshu.com/p/53fdfaae30a3" target="_blank" rel="noopener noreferrer">二十五岁的我</a></div><div class="_19haGh">阅读 58,379</div></div><div class="cuOxAY" role="listitem"><div class="_3L5YSq" title="我不是欲女，我是肉女。"><a class="_1-HJSV _1OhGeD" href="https://www.jianshu.com/p/46514315ecd4" target="_blank" rel="noopener noreferrer">我不是欲女，我是肉女。</a></div><div class="_19haGh">阅读 15,379</div></div></section><section class="-umr26" aria-label="youdao-ad"><img class="QrLrqK" src="./ceph存储引擎bluestore解析 - 简书_files/image" alt=""><span class="_22kSId">广告</span></section></div></div></aside></div></div><footer style="width:100%"><div class="_2xr8G8"><div class="_1Jdfvb"><div class="TDvCqd"><textarea class="W2TSX_" placeholder="写下你的评论..."></textarea></div><div class="-pXE92"><div class="_3nj4GN" role="button" tabindex="0" aria-label="添加评论"><i aria-label="ic-reply" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-reply"></use></svg></i><span>评论<!-- -->0</span></div><div class="_3nj4GN" role="button" tabindex="0" aria-label="给文章点赞"><i aria-label="ic-like" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-like"></use></svg></i><span>赞</span></div><div class="_3nj4GN ant-dropdown-trigger" role="button" tabindex="0" aria-label="更多操作"><i aria-label="ic-others" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-others"></use></svg></i></div></div></div></div><div class="_1LI0En" style="height: 56px;"></div></footer><div class="_3Pnjry"><div class="_1pUUKr"><div class="_2VdqdF" role="button" tabindex="-1" aria-label="给文章点赞"><i aria-label="ic-like" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-like"></use></svg></i></div><div class="P63n6G"><div class="_2LKTFF"><span class="_1GPnWJ" role="button" tabindex="-1" aria-label="查看点赞列表">赞</span><span class="_1GPnWJ">1<!-- -->赞</span></div></div></div><div class="_1pUUKr"><div class="_2VdqdF" role="button" tabindex="-1" aria-label="赞赏作者"><i aria-label="ic-shang" class="anticon"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-shang"></use></svg></i></div><div class="P63n6G" role="button" tabindex="-1" aria-label="查看赞赏列表">赞赏</div></div></div></div><script async="" src="./ceph存储引擎bluestore解析 - 简书_files/hm.js.下载"></script><script async="" src="./ceph存储引擎bluestore解析 - 简书_files/analytics.js.下载"></script><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"isServer":true,"initialState":{"global":{"fontType":"black","locale":"zh-CN","readMode":"day","seoList":[{"comments_count":0,"public_abbr":"ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memst...","share_image_url":"http://upload-images.jianshu.io/upload_images/7240015-f414db564eff652f","slug":"c46a4178bb93","user":{"id":7240015,"nickname":"LeiLv","slug":"f796a54054d1","avatar":"https://upload.jianshu.io/users/upload_avatars/7240015/26c0bdb2-2375-41b5-9292-5b5256f57114.jpg"},"likes_count":2,"title":"ceph存储引擎bluestore解析","id":17441133,"views_count":3895},{"comments_count":0,"public_abbr":"教程一:视频截图(Tutorial 01: Making Screencaps) 首先我们需要了解视频文件的一些基...","share_image_url":"","slug":"534a5bdc9aaa","user":{"id":3118986,"nickname":"90后的思维","slug":"c89332076e7a","avatar":"https://upload.jianshu.io/users/upload_avatars/3118986/7ab503d7-5e82-4f35-b273-8d9620fe4523.jpg"},"likes_count":3,"title":"iOS ffmpeg 理解","id":7627281,"views_count":2472},{"comments_count":0,"public_abbr":"背景 一年多以前我在知乎上答了有关LeetCode的问题, 分享了一些自己做题目的经验。 张土汪：刷leetcod...","share_image_url":"http://upload-images.jianshu.io/upload_images/1088843-4dbeb1d476ae23b2.jpg","slug":"9bc86a6bbbbc","user":{"id":1088843,"nickname":"张土汪","slug":"0e6b059ad57e","avatar":"https://upload.jianshu.io/users/upload_avatars/1088843/a1cc2282234d.jpg"},"likes_count":31,"title":"LeetCode/LintCode ReviewPage 题解-总结","id":3677349,"views_count":9895},{"comments_count":0,"public_abbr":"MySQL技术内幕：InnoDB存储引擎(第2版) 姜承尧 第1章 MySQL体系结构和存储引擎 \u003e\u003e 在上述例子...","share_image_url":"","slug":"3eca0b18cf51","user":{"id":58733,"nickname":"沉默剑士","slug":"6ca93a173ea2","avatar":"https://cdn2.jianshu.io/assets/default_avatar/1-04bbeead395d74921af6a4e8214b4f61.jpg"},"likes_count":15,"title":"《MySQL技术内幕：InnoDB存储引擎(第2版)﻿》书摘","id":14211522,"views_count":4430},{"comments_count":4,"public_abbr":"“心灵对话•写作”小组第11篇文字 在朋友家做客一周，心理小组也持续了几乎一周。每天都要聊聊内心的话题，感觉内心平...","share_image_url":"http://upload-images.jianshu.io/upload_images/4218602-9922a42e2df5cc93.jpg","slug":"565a8ba2e347","user":{"id":4218602,"nickname":"尼农的小鹿","slug":"4dc939d7d71b","avatar":"https://upload.jianshu.io/users/upload_avatars/4218602/e9ad8adb-21f6-48c5-a89b-18102c97d414.jpg"},"likes_count":2,"title":"1.24-生活不在别处","id":8677248,"views_count":123}],"done":false,"$ua":{"value":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36","isIE11":false,"earlyIE":null,"chrome":"83.0","firefox":null,"safari":null,"isMac":false},"$diamondRate":{"displayable":false,"rate":0},"$modal":{"ContributeModal":false,"RewardListModal":false,"PayModal":false,"CollectionModal":false,"LikeListModal":false,"ReportModal":false,"QRCodeShareModal":false,"BookCatalogModal":false,"RewardModal":false}},"note":{"data":{"is_author":false,"last_updated_at":1512879891,"public_title":"ceph存储引擎bluestore解析","purchased":false,"liked_note":false,"comments_count":0,"free_content":"\u003cp\u003eceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memstore以及最新的bluestore，目前默认使用的filestore，但是因为filestore在写数据前需要先写journal，会有一倍的写放大，并且filestore一开始只是对于机械盘进行设计的，没有专门针对ssd做优化考虑，因此诞生的bluestore初衷就是为了减少写放大，并针对ssd做优化，而且直接管理裸盘，从理论上进一步减少文件系统如ext4/xfs等部分的开销，目前bluestore还处于开发优化阶段，在jewel版本还是试用版本，并且最新的master相比jewel已经做了大的重构，预期会在后续的大版本中稳定下来成为默认的存储引擎。本文基于master分支对bluestore存储引擎进行分析。\u003cbr\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003ebluestore整体架构\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 414px; max-height: 280px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 67.63%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"414\" data-height=\"280\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-347c3bcbb7e7f270\" data-original-width=\"414\" data-original-height=\"280\" data-original-format=\"image/png\" data-original-filesize=\"16098\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003ebluestore直接管理裸设备，抛弃了ext4/xfs等本地文件系统，BlockDevice实现在用户态下使用linux aio直接对裸设备进行I/O操作。既然是直接管理裸设备就必然需要进行裸设备的空间管理，对应的就是Allocator，目前支持StupidAllocator和BitmapAllocator两种分配器。相关的元数据以kv的形式保存到kv数据库里，默认使用的是rocksdb，由于rocksdb本身是基于文件系统的，不是直接操作裸设备，但是rocksdb也比较灵活，将系统相关的处理抽象成Env，用户可用实现相应的接口，rocksdb默认的Env是PosixEnv，直接对接本地文件系统，为此，bluestore实现了一个BlueRocksEnv，继承自EnvWrapper，来为rocksdb提供底层系统的封装，为了对接BlueRocksEnv，实现了一个小的文件系统BlueFS，只实现rocksdb Env需要的接口，在系统启动mount这个文件系统的时候将所有的元数据都加载到内存中，BluesFS的数据和日志文件都通过BlockDevice保存到裸设备上，BlueFS和BlueStore可以共享裸设备，也可以分别指定不同的设备。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003ebluestore元数据\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 298px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 46.56%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"298\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-1a56e633fde7fceb\" data-original-width=\"640\" data-original-height=\"298\" data-original-format=\"image/png\" data-original-filesize=\"37840\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e在之前的存储引擎filestore里，对象的表现形式是对应到文件系统里的文件，默认4MB大小的文件，但是在bluestore里，已经没有传统的文件系统，而是自己管理裸盘，因此需要有元数据来管理对象，对应的就是Onode，Onode是常驻内存的数据结构，持久化的时候会以kv的形式存到rocksdb里。\u003c/p\u003e\u003cp\u003e在onode里又分为lextent，表示逻辑的数据块，用一个map来记录，一个onode里会存在多个lextent，lextent通过blob的id对应到blob（bluestore_blob_t ），blob里通过pextent对应到实际物理盘上的区域（pextent里就是offset和length来定位物理盘的位置区域）。一个onode里的多个lextent可能在同一个blob里，而一个blob也可能对应到多个pextent。\u003c/p\u003e\u003cp\u003e另外还有Bnode这个元数据，它是用来表示多个object可能共享extent，目前在做了快照后写I/O触发的cow进行clone的时候会用到。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003eI/O读写映射逻辑\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003e写I/O处理\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e到达bluestore的I/O的offset和length都是对象内（onode）的，offset是相对于这个对象起始位置的偏移，在_do_write里首先就会根据最小分配单位min_alloc_size进行判断，从而将I/O分为对齐和非对齐的。如下图所示：\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 605px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 94.53%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"605\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-76c6c8ee954202ca\" data-original-width=\"640\" data-original-height=\"605\" data-original-format=\"image/jpeg\" data-original-filesize=\"37512\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e当一个写请求按照min_alloc_size进行拆分后，就会分为对齐写，对应到do_write_big，非对齐写（即落到某一个min_alloc_size区间的写I/O（对应到do_write_small）。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003edo_write_big\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e对齐到min_alloc_size的写请求处理起来比较简单，有可能是多个min_alloc_size的大小，在处理时会根据实际大小新生成lextent和blob，这个lextent跨越的区域是min_alloc_size的整数倍，如果这段区间是之前写过的，会将之前的lextent记录下来便于后续的空间回收。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003edo_write_small\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e在处理落到某个min_alloc_size区间的写请求时，会首先根据offset去查找有没有可以复用的blob，因为最小分配单元是min_alloc_size，默认64KB，如果一个4KB的写I/O就只会用到blob的一部分，blob里剩余的还能放其他的。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003e1）没有找到可以复用的blob，新生成blob\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 616px; max-height: 389px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 63.14999999999999%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"616\" data-height=\"389\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-7fd66a37c6a59c52\" data-original-width=\"616\" data-original-height=\"389\" data-original-format=\"image/png\" data-original-filesize=\"17245\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e在处理还还需要根据offset和len是否对齐到block_size（默认是4KB）进行补零对齐的操作，之所以需要补齐是与后续的写盘操作有关，真正写盘时有两种方式，一种是Direct I/O的方式，这种要求偏移和缓冲区都对齐的，另外一种非Direct I/O，即Buffered I/O，这种可以不对齐，但是是写到cache里，然后再sync刷到磁盘上，比如只写了100字节，在内核里是需要先从设备上读出来补齐成一个完整的扇区，然后再刷的，这样反而降低了效率。因此在bluestore里直接处理好对齐，对于后面的写盘来说比较有利，这里对齐到block_size，是个可配置的参数。\u003c/p\u003e\u003cp\u003e进行对齐补零时就是按照如上图那样把前后对齐到block_size，然后再把对齐后的offset和len作为lextent，进而放到blob里。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003e2）找到可以复用的blob\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e对于可以复用的blob，也是先按照block_size进行对齐补零的动作，然后再判断是否可以直接使用blob里空闲的空间进行区分做不同的处理。\u003c/p\u003e\u003cp\u003e\u003cb\u003ea）直接写在blob未使用的空间上\u003c/b\u003e\u003c/p\u003e\u003cp\u003e这种情况下直接新生成lextent放到blob里。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 538px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 84.06%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"538\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-961b13b2350ee89a\" data-original-width=\"640\" data-original-height=\"538\" data-original-format=\"image/jpeg\" data-original-filesize=\"28251\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003cb\u003eb）覆盖写的情况\u003c/b\u003e\u003c/p\u003e\u003cp\u003e比如下面的这种情况，写I/O会覆盖部分已经写过的数据。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 240px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 37.5%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"240\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-5b70fa10d6f7f9a0\" data-original-width=\"640\" data-original-height=\"240\" data-original-format=\"image/png\" data-original-filesize=\"35889\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e对于这种情况的处理如下图：也是需要先处理对齐补零的情况，如果覆盖的区域刚好是已经对齐到block_size，那么就不需要从磁盘读数据，但是如果覆盖的区域没有对齐到block_size，那么就需要把不对齐的那部分读出来，拼成一个对齐的buffer，然后新生成lextent，并且会对原来那个lextent进行调整，会记录需要回收的那部分区域。对于覆盖写的情况，都不是直接写盘，而是通过wal写到rocksdb。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 367px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 57.34%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"367\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-05aaa1bdb7aa4179\" data-original-width=\"640\" data-original-height=\"367\" data-original-format=\"image/png\" data-original-filesize=\"62575\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003e整体写I/O的逻辑\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e之前组内同事画过一个流程图，这里借用一下算是一个简单的总结。\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 601px; max-height: 893px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 127.62%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"601\" data-height=\"767\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-7b4030f7ddcc23c0\" data-original-width=\"601\" data-original-height=\"767\" data-original-format=\"image/jpeg\" data-original-filesize=\"77755\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cb\u003e读I/O的处理\u003c/b\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 188px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 29.38%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"188\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-f963f47ed8663a34\" data-original-width=\"640\" data-original-height=\"188\" data-original-format=\"image/png\" data-original-filesize=\"31058\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e读I/O请求的处理时也是通过寻找相关联的lextent，可能会存在空洞的情况，即读到未写过的数据，这部分就直接补零。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003cb\u003eclone及extent共享\u003c/b\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e前面说到Bnode就是用来记录共享的lextent，目前是在做完快照后对原卷进行写I/O会触发cow，从而产生clone操作。clone时就是将原对象的blob从onode-\u0026gt;blob_map移到onode-\u0026gt;bnode-\u0026gt;blob_map，并且将blob id置为负的，并设置共享标记，然后将新的快照对象的onode-\u0026gt;bnode指向原对象的onode-\u0026gt;bnode，并且用原onode里的lextents里的值赋给新的onode的lextents，从而达到共享extent的目的，图示仅供参考。\u003c/p\u003e\u003cp\u003e\u003ca href=\"\" target=\"_blank\"\u003e\u003c/a\u003e\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 343px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 53.59%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"343\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-a9e96272bca28bac\" data-original-width=\"640\" data-original-height=\"343\" data-original-format=\"image/png\" data-original-filesize=\"38864\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在clone完之后，继续对原对象进行写I/O操作时，当碰到共享的blob时就需要跳过，新生成blob，并且取消对原来那部分lextent的引用，在后续的空间释放时的判断依据就是否还有引用。\u003c/p\u003e\u003cdiv class=\"image-package\"\u003e\n\u003cdiv class=\"image-container\" style=\"max-width: 640px; max-height: 378px;\"\u003e\n\u003cdiv class=\"image-container-fill\" style=\"padding-bottom: 59.06%;\"\u003e\u003c/div\u003e\n\u003cdiv class=\"image-view\" data-width=\"640\" data-height=\"378\"\u003e\u003cimg data-original-src=\"//upload-images.jianshu.io/upload_images/7240015-d15c0ee764fff2dd\" data-original-width=\"640\" data-original-height=\"378\" data-original-format=\"image/jpeg\" data-original-filesize=\"22294\"\u003e\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"image-caption\"\u003e\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cb\u003e小结\u003c/b\u003e\u003c/p\u003e\u003cp\u003e本文总体上介绍了bluestore的架构、相关元数据及内部I/O映射的逻辑，这还只是bluestore的冰山一角，后续会陆续对bluestore的处理流程、空间分配器、缓存管理、压缩等实现进行分析。\u003c/p\u003e\u003cp\u003e来源：\u003ca href=\"\" target=\"_blank\"\u003eSystem Notes\u003c/a\u003e\u003c/p\u003e\u003cp\u003e原文：http://www.sysnote.org/2016/08/19/ceph-bluestore/\u003c/p\u003e","voted_down":false,"rewardable":true,"show_paid_comment_tips":false,"share_image_url":"http://upload-images.jianshu.io/upload_images/7240015-76c6c8ee954202ca","slug":"26acd6185747","user":{"liked_by_user":false,"following_count":1295,"gender":1,"slug":"f796a54054d1","intro":"","likes_count":1631,"nickname":"LeiLv","badges":[],"total_fp_amount":"112099900924822094335","wordage":935154,"avatar":"https://upload.jianshu.io/users/upload_avatars/7240015/26c0bdb2-2375-41b5-9292-5b5256f57114.jpg","id":7240015,"liked_user":false},"likes_count":0,"paid_type":"free","show_ads":true,"paid_content_accessible":false,"total_fp_amount":"0","trial_open":false,"reprintable":true,"bookmarked":false,"wordage":2182,"featured_comments_count":0,"downvotes_count":0,"wangxin_trial_open":false,"commentable":true,"total_rewards_count":0,"id":17187165,"notebook":{"name":""},"description":"ceph后端支持多种存储引擎，以插件式的方式来进行管理使用，目前支持filestore，kvstore，memstore以及最新的bluestore，目前默认使用的files...","first_shared_at":1505627952,"views_count":368,"notebook_id":16614996},"baseList":{"likeList":[],"rewardList":[]},"status":"success","statusCode":0},"user":{"isLogin":false,"userInfo":{}},"comments":{"list":[],"featuredList":[]}},"initialProps":{"pageProps":{"query":{"slug":"26acd6185747"}},"localeData":{"common":{"jianshu":"简书","diamond":"简书钻","totalAssets":"总资产{num}","diamondValue":" (约{num}元)","login":"登录","logout":"注销","register":"注册","on":"开","off":"关","follow":"关注","followBook":"关注连载","following":"已关注","cancelFollow":"取消关注","publish":"发布","wordage":"字数","audio":"音频","read":"阅读","reward":"赞赏","zan":"赞","comment":"评论","expand":"展开","prevPage":"上一页","nextPage":"下一页","floor":"楼","confirm":"确定","delete":"删除","report":"举报","fontSong":"宋体","fontBlack":"黑体","chs":"简体","cht":"繁体","jianChat":"简信","postRequest":"投稿请求","likeAndZan":"喜欢和赞","rewardAndPay":"赞赏和付费","home":"我的主页","markedNotes":"收藏的文章","likedNotes":"喜欢的文章","paidThings":"已购内容","wallet":"我的钱包","setting":"设置","feedback":"帮助与反馈","loading":"加载中...","needLogin":"请登录后进行操作","trialing":"文章正在审核中...","reprintTip":"禁止转载，如需转载请通过简信或评论联系作者。"},"error":{"rewardSelf":"无法打赏自己的文章哟~"},"message":{"paidNoteTip":"付费购买后才可以参与评论哦","CommentDisableTip":"作者关闭了评论功能","contentCanNotEmptyTip":"回复内容不能为空","addComment":"评论发布成功","deleteComment":"评论删除成功","likeComment":"评论点赞成功","setReadMode":"阅读模式设置成功","setFontType":"字体设置成功","setLocale":"显示语言设置成功","follow":"关注成功","cancelFollow":"取消关注成功","copySuccess":"复制代码成功"},"header":{"homePage":"首页","download":"下载APP","discover":"发现","message":"消息","reward":"赞赏支持","editNote":"编辑文章","writeNote":"写文章"},"note":{},"noteMeta":{"lastModified":"最后编辑于 ","wordage":"字数 {num}","viewsCount":"阅读 {num}"},"divider":{"selfText":"以下内容为付费内容，定价 ¥{price}","paidText":"已付费，可查看以下内容","notPaidText":"还有 {percent} 的精彩内容","modify":"点击修改"},"paidPanel":{"buyNote":"支付 ¥{price} 继续阅读","buyBook":"立即拿下 ¥{price}","freeTitle":"该作品为付费连载","freeText":"购买即可永久获取连载内的所有内容，包括将来更新的内容","paidTitle":"还没看够？拿下整部连载！","paidText":"永久获得连载内的所有内容, 包括将来更新的内容"},"book":{"last":"已是最后","lookCatalog":"查看连载目录","header":"文章来自以下连载"},"action":{"like":"{num}人点赞","collection":"收入专题","report":"举报文章"},"comment":{"allComments":"全部评论","featuredComments":"精彩评论","closed":"评论已关闭","close":"关闭评论","open":"打开评论","desc":"按时间倒序","asc":"按时间正序","disableText1":"用户已关闭评论，","disableText2":"与Ta简信交流","placeholder":"写下你的评论...","publish":"发表","create":" 添加新评论","reply":" 回复","restComments":"还有{num}条评论，","expandImage":"展开剩余{num}张图","deleteText":"确定要删除评论么？"},"collection":{"title":"被以下专题收入，发现更多相似内容","putToMyCollection":"收入我的专题"},"seoList":{"title":"推荐阅读","more":"更多精彩内容"},"sideList":{"title":"推荐阅读"},"wxShareModal":{"desc":"打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮"},"bookChapterModal":{"try":"试读","toggle":"切换顺序"},"collectionModal":{"title":"收入到我管理的专题","search":"搜索我管理的专题","newCollection":"新建专题","create":"创建","nothingFound":"未找到相关专题","loadMore":"展开查看更多"},"contributeModal":{"search":"搜索专题投稿","newCollection":"新建专题","addNewOne":"去新建一个","nothingFound":"未找到相关专题","loadMore":"展开查看更多","managed":"我管理的专题","recommend":"推荐专题"},"QRCodeShow":{"payTitle":"微信扫码支付","payText":"支付金额"},"rewardModal":{"title":"给作者送糖","custom":"自定义","placeholder":"给Ta留言...","choose":"选择支付方式","balance":"简书余额","tooltip":"网站该功能暂时下线，如需使用，请到简书App操作","confirm":"确认支付","success":"赞赏成功"},"payModal":{"payBook":"购买连载","payNote":"购买文章","promotion":"优惠券","promotionFetching":"优惠券获取中...","noPromotion":"无可用优惠券","promotionNum":"{num}张可用","noUsePromotion":"不使用优惠券","validPromotion":"可用优惠券","invalidPromotion":"不可用优惠券","total":"支付总额","tip1":"· 你将购买的商品为虚拟内容服务，购买后不支持退订、转让、退换，请斟酌确认。","tip2":"· 购买后可在“已购内容”中查看和使用。","success":"购买成功"},"reportModal":{"ad":"广告及垃圾信息","plagiarism":"抄袭或未授权转载","placeholder":"写下举报的详情情况（选填）","success":"举报成功"}},"currentLocale":"zh-CN","asPath":"/p/26acd6185747"}},"page":"/p/[slug]","query":{"slug":"26acd6185747"},"buildId":"y7459tABe23wtzf2Yq_u9","assetPrefix":"https://cdn2.jianshu.io/shakespeare"}</script><script nomodule="" src="./ceph存储引擎bluestore解析 - 简书_files/polyfills-6f63874b7f93cc8cfe44.js.下载"></script><script async="" data-next-page="/p/[slug]" src="./ceph存储引擎bluestore解析 - 简书_files/[slug].js.下载"></script><script async="" data-next-page="/_app" src="./ceph存储引擎bluestore解析 - 简书_files/_app.js.下载"></script><script src="./ceph存储引擎bluestore解析 - 简书_files/webpack-ad03007e443a25fa4d15.js.下载" async=""></script><script src="./ceph存储引擎bluestore解析 - 简书_files/commons.6f517ba4cf1108d0202d.js.下载" async=""></script><script src="./ceph存储引擎bluestore解析 - 简书_files/styles.4eb5917714db060a5a06.js.下载" async=""></script><script src="./ceph存储引擎bluestore解析 - 简书_files/main-c0e08023b1a3520cf518.js.下载" async=""></script><ins class="adsbygoogle adsbygoogle-noablate" data-adsbygoogle-status="done" style="display: none !important;"><ins id="aswift_1_expand" style="display:inline-table;border:none;height:0px;margin:0;padding:0;position:relative;visibility:visible;width:0px;background-color:transparent;"><ins id="aswift_1_anchor" style="display:block;border:none;height:0px;margin:0;padding:0;position:relative;visibility:visible;width:0px;background-color:transparent;"><iframe id="aswift_1" name="aswift_1" style="left:0;position:absolute;top:0;border:0;width:undefinedpx;height:undefinedpx;" sandbox="allow-forms allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation" frameborder="0" src="./ceph存储引擎bluestore解析 - 简书_files/ads(1).html" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" data-google-container-id="a!1" data-load-complete="true"></iframe></ins></ins></ins><iframe id="google_osd_static_frame_6204108001191" name="google_osd_static_frame" style="display: none; width: 0px; height: 0px;" src="./ceph存储引擎bluestore解析 - 简书_files/saved_resource(1).html"></iframe></body><iframe id="google_esf" name="google_esf" src="./ceph存储引擎bluestore解析 - 简书_files/zrt_lookup.html" data-ad-client="ca-pub-3077285224019295" style="display: none;"></iframe></html>